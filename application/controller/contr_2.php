<?php
    error_reporting(E_ALL);
        
	$db = new DB3();    
    $q = $db->Select("
    select     
    s.id, 
    s.emp_id, 
    emp_name(s.emp_id) empname, 
    s.sql_text, 
    to_char(s.date_add, 'DD.MM.YYYY HH24:MI:SS') date_search, 
    s.typ, 
    s.form_name,
    G.BRANCH_ID,
    branch_name(G.BRANCH_ID) region
from 
    SIAP_SEARCH_USERS s,
    gs_emp g
where
    G.EMP_ID = S.EMP_ID
    and s.form_name in(
        'Поиск договоров',
        'Поиск и просмотр клиентов',
        'Проверка существования договора в базе'
    )
    and s.date_add >= sysdate - 90
    and (s.sql_text like '%clients%' or s.sql_text like '%clients_fio%' or s.sql_text like '%date_search%' or s.sql_text like '%state%')
order by s.form_name
    ");
    
    
    $q = $db->Select("select 
        s.id, 
        s.emp_id, 
        emp_name(s.emp_id) empname, 
        s.sql_text, 
        to_char(s.date_add, 'DD.MM.YYYY HH24:MI:SS') date_search, 
        s.typ, 
        s.form_name,
        G.BRANCH_ID,
        branch_name(G.BRANCH_ID) region 
    from 
        SIAP_SEARCH_USERS s,
        gs_emp g 
    where
        G.EMP_ID = S.EMP_ID
        and s.id in(
599472,598973,598966,598934,598820,598781,608484,598759,598748,598717,598653,598601,595920,595443,598591,
598500,598396,598351,598221,598167,607851,607850,607730,607726,608621,608596,608307,608239,608173,597857,597433,597360,597336,597328,597191,
607516,607510,607084,607082,607076,600892,600822,608128,608084,608082,608081,608080,608007,607974,607912,607848,596810,596660,596654,596568,
596473,599302,599299,599195,607768,607764,607433,607371,607327,607295,607241,608595,608341,608328,608320,608248,596352,596091,596089,606528,
606498,599103,598974,598682,600745,600738,599859,599816,606929,606887,606873,606814,596075,605910,598159,598134,598124,598123,598104,598029,
597863,597839,597831,597824,597769,599413,606255,606240,606234,606180,606136,606087,605978,605977,605957,608126,608073,608052,608022,607839,
607838,607837,607637,595842,595783,605408,597214,597126,595474,596543,605830,607425,607420,607305,607303,607291,607288,607055,607048,595296,
604689,604688,604653,604596,604567,604547,604465,604347,604323,594112,594111,592319,592145,605769,604072,604071,606696,606305,606304,606201,
605844,605840,605838,605824,605822,605821,604331,603472,603353,602741,594986,594980,594884,590610,593126,591352,591327,605269,601730,601485,
592041,590714,590601,605730,605708,605642,605532,605481,605354,605213,591357,591207,604423,603893,594756,594695,594402,594042,594041,593974,
593790,602879,602840,592426,592326,592207,590982,606266,592672,605295,605128,602933,601405,601404,590837,590785,590784,590417,606794,606675,
606338,606196,605839,605710,593261,604736,604618,604556,604490,601306,601301,601297,601291,601283,601274,601272,601265,603719,603475,601316,
601315,601314,601281,604572,592857,592815,592619,592530,592006,591962,591953,591769,590867,607435,607431,607413,605329,595222,595219,595147,
595033,594902,594896,592646,590873,590872,591440,591309,591117,591007,590956,590934,590933,590924,603166,603150,601660,603974,602243,602136,
601471,604874,604317,603923,602998,601997,602815,602710,602522,601256,601254,601230,594000,591265,601400,594938,600276,600199,600145,600075,
601260,601252,601249,600546,600540,599599,604619,607544,599178,598474,598405,607380,607348,607322,607321,607320,607319,607318,607317,607316,
607315,607314,607313,607312,607311,607310,607309,607308,607307,598946,598899,604529,604475,604414,604390,604246,604170,604144,607384,607334,
607267,607221,597225,597218,597180,597177,597175,597163,597121,597115,595940,605988,605907,598809,598804,598802,598800,598799,598795,598792,
598789,598787,602375,603171,602114,601964,607218,607122,606954,606942,606930,606904,595490,595471,605798,598699,598575,598490,598417,598392,
598357,598347,598337,598322,598321,598270,601942,601941,601077,601007,600855,600768,601804,601681,601470,601351,606792,606565,606532,606497,
606463,606392,595458,605230,605214,604636,604430,598071,598031,597893,597779,600692,600691,599908,599628,599499,599476,608149,608015,607970,
600022,599910,606296,606161,605512,595237,604311,604310,604309,604308,604307,604262,597548,598669,598640,598465,598458,598371,598293,607949,
607880,607871,607858,607853,607819,607818,599577,599386,599214,598556,598502,605423,605419,605240,605238,597496,598171,598150,597707,607785,
607765,607718,607698,607696,607676,607555,607552,597848,604785,604588,604498,604489,604336,594543,603684,597489,597311,597293,597289,597268,
597216,597267,597224,597212,597210,607172,596641,596393,595899,595450,595354,604195,604194,604073,603981,603937,603908,603889,603288,603229,
593214,592547,592546,592544,603504,596610,596442,596241,596126,607014,606979,606680,606458,594569,594348,594268,592201,591946,602750,596457,
593535,591268,591239,606154,606153,606105,606098,594255,594141,594097,602593,602592,602589,602588,602582,602040,601813,601619,596267,595956,
594874,594819,594538,593580,591103,590537,593416,593408,593014,601872,601770,601735,601647,601484,601422,601408,601399,601374,601359,601302,
601239,590595,601449,601420,601047,594252,594088,605783,605643,592662,592553,592520,592511,601112,601068,600995,601001,600945,600930,592079,
591595,607054,606670,606622,593102,592932,592649,592557,592042,591989,605453,592238,590675,590367,600343,600334,600295,600287,600265,600220,
591472,590981,590913,600045,594358,594025,606436,606432,606430,606427,606424,606422,606351,606349,606325,606323,606322,606321,606317,606278,
606224,606223,606222,606214,606213,606163,592519,592265,600213,600204,600203,600194,600192,600187,600184,600176,600167,600164,600156,600151,
600149,600138,600137,600134,600126,599900,599641,594052,593582,593581,605883,605837,605793,605607,591885,591822,604943,604914,604885,592474,
591010,608377,600123,600117,600116,600113,600109,600094,600091,600086,600081,600079,596840,596838,596739,595983,595966,599520,599461,596930,
595661,595607,595015,594991,604875,604838,604836,604826,604823,604821,604818,604816,604805,604803,604795,607908,607706,607629,607571,599851,
599200,599198,608750,608749,608743,608740,608739,608704,608688,608677,608430,608416,608336,607796,607457,604504,604421,604384,604370,604349,
604201,604199,604110,604109,603763,600330,600328,600321,600298,600294,600286,600282,600248,600217,600209,594856,607852,607627,607558,607459,
607217,602107,602083,602082,602078,602076,602071,602069,602068,602067,602064,602061,602056,602053,602050,602048,602044,602043,602042,602039,
602038,602033,602030,602028,602024,602022,602020,602017,602016,602014,601984,601966,597572,606795,606705,606401,606303,606273,606195,598041,
597942,597911,597908,599629,599622,599573,599391,599390,600205,600195,600185,600182,600177,600170,600168,600155,600152,600047,594367,594364,
594264,606810,606762,606726,606701,606682,606676,606667,606617,601944,601940,601937,601930,601924,601918,601915,601911,601908,601900,601896,
601891,601590,597318,598942,598910,594235,594232,593794,601580,596909,605397,605368,605352,605351,605215,597412,597294,597120,608472,608446,
598280,598077,597936,608715,608702,608662,608659,608628,608592,599159,598723,598636,598532,598529,598454,601455,601255,595676,595161,595019,
605094,604531,604417,596951,596947,596894,608188,608187,607915,607763,607761,597659,593283,606164,605828,605584,605581,601124,601061,601036,
594181,594176,594175,594169,594168,594148,596818,596814,607758,607752,607750,607473,607412,607274,607205,607203,607197,607181,607080,606859,
606717,596415,596398,596383,596261,595818,595659,595636,607878,607628,598138,598119,598039,597965,593094,605578,605563,605560,605559,605558,
605557,605556,605555,605169,600979,600916,593998,593951,593845,593843,593838,593834,593827,593814,603303,603277,602858,596594,605973,605972,
605971,595191,607505,607504,597795,597618,592725,605113,600838
)
");
    
    $contracts = array();
    
    foreach($q as $k=>$v){
        if($v['FORM_NAME'] == 'Поиск договоров'){
            $sqls = $v['SQL_TEXT'];
            $sqls.= " where paym_code like '01%'";
            
            $qs = $db->Select($sqls);
            if(count($qs) > 0){
                foreach($qs as $t=>$d){
                    if(isset($d['CNCT_ID'])){
                        $cnct = $d['CNCT_ID'];                    
                        if(!isset($contracts[$cnct])){
                            $contracts[$cnct]['contract'] = $d;
                        }
                        
                        if(!isset($contracts[$cnct]['search'])){
                            $contracts[$cnct]['search'] = array();
                        }
                        
                        array_push($contracts[$cnct]['search'], $v);   
                    }                    
                }
            }
        }
    }
    
echo '<pre>';
print_r($contracts);
echo '</pre>';    
    
//$timeend = date("H:i:s");
//echo 'time end: '.$timeend."<br />";    
exit;    